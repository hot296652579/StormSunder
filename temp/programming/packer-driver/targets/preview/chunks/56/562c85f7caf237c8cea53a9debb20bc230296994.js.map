{"version":3,"sources":["file:///E:/CocosCreator/StormSunder_Github/StormSunder/assets/module_storm_sunder/Script/UIJoyStick.ts"],"names":["_decorator","Component","CCFloat","Input","math","Sprite","v3","Vec3","ccclass","property","UIJoyStick","initJoyStickBgPosition","_dir","ZERO","dir","value","start","node","ins","joyStickBg","active","on","EventType","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","TOUCH_START","onTouchStart","worldPosition","clone","onDestroy","off","eventTouch","x","touch","getUILocationX","y","getUILocationY","setWorldPosition","touchEvent","localPosition","inverseTransformPoint","thumbnailPosition","len","length","normalize","scaleAndAdd","clamp","radius","joystickPoint","setPosition"],"mappings":"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","sourcesContent":["import { _decorator, Component, CCFloat, EventTouch, Input, Node, math, Sprite, v3, Vec3 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n/**\r\n * 摇杆控制器\r\n */\r\n@ccclass('UIJoyStick')\r\nexport class UIJoyStick extends Component {\r\n\r\n    public static ins: UIJoyStick = null!;\r\n\r\n    /**\r\n     * 手指部分\r\n     */\r\n    @property(Sprite)\r\n    joystickPoint: Sprite = null!;\r\n\r\n    /**\r\n     * 摇杆的背景\r\n     */\r\n    @property(Sprite)\r\n    joyStickBg: Sprite = null!;\r\n\r\n    /**\r\n     * 摇杆的半径\r\n     */\r\n    @property(CCFloat)\r\n    radius: number = 130;\r\n\r\n    /**\r\n     * 摇杆初始化的位置\r\n     */\r\n    initJoyStickBgPosition: Vec3 = v3()\r\n\r\n    /**\r\n     * 方向\r\n     */\r\n    private _dir: Vec3 = new Vec3(Vec3.ZERO);\r\n    public get dir(): Vec3 {\r\n        return this._dir;\r\n    }\r\n    public set dir(value: Vec3) {\r\n        this._dir = value;\r\n    }\r\n\r\n    start() {\r\n        if (!this.node) return\r\n\r\n        if (!UIJoyStick.ins) {\r\n            UIJoyStick.ins = this;\r\n        }\r\n\r\n        this.joyStickBg.node.active = false;\r\n\r\n        this.node.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.node.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.on(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n        this.node.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.initJoyStickBgPosition = this.joyStickBg.node.worldPosition.clone();\r\n    }\r\n\r\n    onDestroy() {\r\n        this.node.off(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.node.off(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.off(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n        this.node.off(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n    }\r\n\r\n    onTouchStart(eventTouch: EventTouch) {\r\n        this.joyStickBg.node.active = true;\r\n        let x = eventTouch.touch?.getUILocationX()!;\r\n        let y = eventTouch.touch?.getUILocationY()!;\r\n        this.joyStickBg.node.setWorldPosition(x, y, 0);\r\n    }\r\n\r\n    /**\r\n     * 触摸移动\r\n     * @param touchEvent \r\n     */\r\n    onTouchMove(touchEvent: EventTouch) {\r\n        // 获取摇杆在 UI 的位置\r\n        let x = touchEvent.touch?.getUILocationX()!;\r\n        let y = touchEvent.touch?.getUILocationY()!;\r\n\r\n        let worldPosition = new Vec3(x, y, 0);\r\n        let localPosition = v3();\r\n        // 转化摇杆的位置到背景图的本地坐标\r\n        this.joyStickBg.node.inverseTransformPoint(localPosition, worldPosition);\r\n        let thumbnailPosition = v3();\r\n        let len = localPosition.length();\r\n        localPosition.normalize();\r\n        Vec3.scaleAndAdd(thumbnailPosition, v3(), localPosition, math.clamp(len, 0, this.radius));\r\n\r\n        this.joystickPoint.node.setPosition(thumbnailPosition);\r\n\r\n        // 将计算的结果赋予给 Input\r\n        // VirtualInput.horizontal = this.joystickPoint.node.position.x / this.radius;\r\n        // VirtualInput.vertical = this.joystickPoint.node.position.y / this.radius;\r\n\r\n        this.dir = thumbnailPosition.clone().normalize();\r\n    }\r\n\r\n    /**\r\n     * 触摸结束\r\n     * @param touchEvent \r\n     */\r\n    onTouchEnd(touchEvent: EventTouch) {\r\n        this.joyStickBg.node.active = false;\r\n        this.joystickPoint.node.setPosition(v3());\r\n        // VirtualInput.horizontal = 0;\r\n        // VirtualInput.vertical = 0;\r\n        this.dir = v3(0, 0, 0);\r\n        // 摇杆的位置回归到初始化位置\r\n        this.joyStickBg.node.worldPosition = this.initJoyStickBgPosition;\r\n    }\r\n}\r\n\r\n"]}